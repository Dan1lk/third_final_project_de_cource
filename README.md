# ETL project

Данный проект является ETL-проектом. Сначала загружаем csv файл из облачного хранилища, затем обрабатываем, делаем аналитику и результат загружаем в базу данных PostgreSQL.

## Инструкция по запуску:
### Собираем Docker-образы
Для этого в терминале пишем
```bash
docker-compose up -d --build
```
## Сервисы
| Сервис     | Адрес                 |
|------------|-----------------------|
| Airflow    | http://localhost:8080 |
| PostgreSQL | http://localhost:5432 |

## В этом проекте были поставлены задачи:
1. Загрузите файл данных в DataFrame PySpark. Обязательно выведите количество строк.

2. Убедитесь, что данные корректно прочитаны (правильный формат, отсутствие пустых строк).

3. Преобразуйте текстовые и числовые поля в соответствующие типы данных (например, дата, число).

4. Найдите топ-5 авиалиний с наибольшей средней задержкой.

5. Вычислите процент отмененных рейсов для каждого аэропорта.

6. Определите, какое время суток (утро, день, вечер, ночь) чаще всего связано с задержками рейсов.

7. Добавьте в данные о полетах новые столбцы, рассчитанные на основе существующих данных:

- IS_LONG_HAUL: Флаг, указывающий, является ли рейс дальнемагистральным (если расстояние больше 1000 миль).
- DAY_PART: Определите, в какое время суток происходит вылет (утро, день, вечер, ночь).

8. Создайте схему таблицы в PostgreSQL, которая будет соответствовать структуре ваших данных. PostgreSQL уже находится в docker-compose! Схему нужно создать вне Airflow, например через Dbeaver.

9. Настройте соединение с PostgreSQL из кода, но из PySpark. (обязательно сделать это нужно в Airflow)

10. Загрузите только 10.000 строк из DataFrame в таблицу в PostgreSQL. (обязательно сделать это нужно в Airflow)

11. Выполните SQL скрипт в Python-PySpark скрипте, который выведет компанию - общее время полетов ее самолетов.

## Для этого использовались:
1. Docker-compose c apache/airflow:2.9.2 с сервисом PostgreSQL

2. Dockerfile, где добавил к airflow зависимости и требуемые библиотеки, которые прописаны в requirements.txt

3. В файле main.py прописан код выполнения проекта и все это обернуто в DAG.
После запуска docker-compose up, необходимо переместить файл main.py в папку dags

## Файл, используемый в проекте для обработки:

https://disk.yandex.ru/d/TXZjQ6bbuWCo_g

## Схема данных в файлах:
### 1. Файл с данными о полетах:
- DATE: Дата полета.
- DAY_OF_WEEK: День недели.
- AIRLINE: Авиалиния.
- FLIGHT_NUMBER: Номер рейса.
- TAIL_NUMBER: Номер самолета.
- ORIGIN_AIRPORT: Аэропорт отправления (IATA код).
- DESTINATION_AIRPORT: Аэропорт назначения (IATA код).
- DEPARTURE_DELAY: Задержка при вылете (в минутах).
- DISTANCE: Расстояние (в милях).
- ARRIVAL_DELAY: Задержка при прибытии (в минутах).
- DIVERTED: Был ли рейс перенаправлен.
- CANCELLED: Был ли рейс отменен.
- CANCELLATION_REASON: Причина отмены (A - авиалиния, B - погода, C - NAS, D - безопасность).
- AIR_SYSTEM_DELAY: Задержка по вине системы авиадиспетчерского управления.
- SECURITY_DELAY: Задержка по причинам безопасности.
- AIRLINE_DELAY: Задержка по вине авиалинии.
- LATE_AIRCRAFT_DELAY: Задержка по вине позднего прибытия предыдущего рейса.
- WEATHER_DELAY: Задержка из-за погоды.
- DEPARTURE_HOUR: Час вылета.
- ARRIVAL_HOUR: Час прибытия.


### 2. Файл с данными о аэропортах:
- IATA CODE: Код IATA.
- Airport: Название аэропорта.
- City: Город.
- Latitude: Широта.
- Longitude: Долгота.

### 3. Файл с данными о авиалиниях:
- IATA CODE: Код IATA.
- AIRLINE: Название авиалинии.